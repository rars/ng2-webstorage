{"version":3,"file":"webStorage.js","sourceRoot":"","sources":["../../lib/helpers/webStorage.ts"],"names":[],"mappings":"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","sourcesContent":["import {IWebStorage} from '../interfaces/webStorage';\r\nimport {STORAGE} from '../enums/storage';\r\nimport {StorageObserverHelper} from './storageObserver';\r\nimport {KeyStorageHelper} from './keyStorage';\r\nimport {MockStorageHelper} from './mockStorage';\r\nimport {STORAGE_NAMES} from '../constants/lib';\r\n\r\nconst CACHED = {[STORAGE.local]: {}, [STORAGE.session]: {}};\r\nconst STORAGE_AVAILABILITY = {[STORAGE.local]: null, [STORAGE.session]: null};\r\n\r\nexport class WebStorageHelper {\r\n\r\n\tstatic store(sType:STORAGE, sKey:string, value:any):void {\r\n\t\tthis.getStorage(sType).setItem(sKey, JSON.stringify(value));\r\n\t\tCACHED[sType][sKey] = value;\r\n\t\tStorageObserverHelper.emit(sType, sKey, value);\r\n\t}\r\n\r\n\tstatic retrieve(sType:STORAGE, sKey:string):string {\r\n\t\tif(sKey in CACHED[sType]) return CACHED[sType][sKey];\r\n\t\tlet value = WebStorageHelper.retrieveFromStorage(sType, sKey);\r\n\t\tif(value !== null) CACHED[sType][sKey] = value;\r\n\t\treturn value;\r\n\t}\r\n\r\n\tstatic retrieveFromStorage(sType:STORAGE, sKey:string) {\r\n\t\tlet data = null;\r\n\r\n\t\ttry {\r\n\t\t\tdata = JSON.parse(this.getStorage(sType).getItem(sKey));\r\n\t\t} catch(err) {\r\n\t\t\tconsole.warn(`invalid value for ${sKey}`);\r\n\t\t}\r\n\r\n\t\treturn data;\r\n\t}\r\n\r\n\tstatic refresh(sType:STORAGE, sKey:string) {\r\n\t\tif(!KeyStorageHelper.isManagedKey(sKey)) return;\r\n\r\n\t\tlet value = WebStorageHelper.retrieveFromStorage(sType, sKey);\r\n\t\tif(value === null) {\r\n\t\t\tdelete CACHED[sType][sKey];\r\n\t\t\tStorageObserverHelper.emit(sType, sKey, null);\r\n\t\t}\r\n\t\telse if(value !== CACHED[sType][sKey]) {\r\n\t\t\tCACHED[sType][sKey] = value;\r\n\t\t\tStorageObserverHelper.emit(sType, sKey, value);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic refreshAll(sType:STORAGE):void {\r\n\t\tObject.keys(CACHED[sType]).forEach((sKey) => WebStorageHelper.refresh(sType, sKey));\r\n\t}\r\n\r\n\tstatic clearAll(sType:STORAGE):void {\r\n\t\tlet storage:IWebStorage = this.getStorage(sType);\r\n\t\tKeyStorageHelper.retrieveKeysFromStorage(storage)\r\n\t\t\t.forEach((sKey) => {\r\n\t\t\t\tstorage.removeItem(sKey);\r\n\t\t\t\tdelete CACHED[sType][sKey];\r\n\t\t\t\tStorageObserverHelper.emit(sType, sKey, null);\r\n\t\t\t});\r\n\t}\r\n\r\n\tstatic clear(sType:STORAGE, sKey:string):void {\r\n\t\tthis.getStorage(sType).removeItem(sKey);\r\n\t\tdelete CACHED[sType][sKey];\r\n\t\tStorageObserverHelper.emit(sType, sKey, null);\r\n\t}\r\n\r\n\tstatic getStorage(sType:STORAGE):IWebStorage {\r\n\t\tif(this.isStorageAvailable(sType))\r\n\t\t\treturn this.getWStorage(sType);\r\n\t\telse\r\n\t\t\treturn MockStorageHelper.getStorage(sType);\r\n\t}\r\n\r\n\tstatic getWStorage(sType:STORAGE):IWebStorage {\r\n\t\tlet storage;\r\n\t\tswitch(sType) {\r\n\t\t\tcase STORAGE.local:\r\n\t\t\t\tstorage = localStorage;\r\n\t\t\t\tbreak;\r\n\t\t\tcase STORAGE.session:\r\n\t\t\t\tstorage = sessionStorage;\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tthrow Error('invalid storage type');\r\n\t\t}\r\n\t\treturn storage;\r\n\t}\r\n\r\n\tstatic isStorageAvailable(sType:STORAGE) {\r\n\t\tif(typeof STORAGE_AVAILABILITY[sType] === 'boolean')\r\n\t\t\treturn STORAGE_AVAILABILITY[sType];\r\n\r\n\t\tlet isAvailable = true, storage;\r\n\t\ttry {\r\n\t\t\tstorage = this.getWStorage(sType);\r\n\t\t\tif(typeof storage === 'object') {\r\n\t\t\t\tstorage.setItem('test-storage', 'foobar');\r\n\t\t\t\tstorage.removeItem('test-storage');\r\n\t\t\t}\r\n\t\t\telse isAvailable = false;\r\n\t\t} catch(e) {\r\n\t\t\tisAvailable = false;\r\n\t\t}\r\n\r\n\t\tif(!isAvailable) console.warn(`${STORAGE_NAMES[sType]} storage unavailable, Ng2Webstorage will use a fallback strategy instead`);\r\n\t\treturn STORAGE_AVAILABILITY[sType] = isAvailable;\r\n\t}\r\n\r\n}\r\n"]}